# Assembling genomes
## Part 1
Right, so here we are! Let’s assemble the genome of *Apodemus sylvaticus*. You are going to run the assembler Hifiasm today.

Have a look at Hifiasm's website:

* [Hifiasm github repository](https://github.com/chhylp123/hifiasm)

Now let’s run the assembly on our subsamples.

First, make sure you are in the directory that you created during our first hands-on tutorial (`~/a_sylvaticus/`). Then let’s create a directory for the hifiasm run.
```console  
mkdir hifiasm
```  
Make sure the conda environment is activated:

```console
conda activate BIO5025
```

Let’s change to the hifiasm folder and create a symlink to the subsample dataset of reads:

```console  
cd ~/a_sylvaticus/hifiasm/
ln -s path/mApoSyl1.60.HiFi.fasta
```

Now let’s call hifiasm and have a look at the parameters it prints:

```console  
hifiasm
```

And this is the line you will run:

```console  
hifiasm -f0 --primary -t 1 -o mApoSyl1.60.hifiasm mApoSyl1.60.HiFi.fasta
```

PS: the `-o` option defines the *prefix* which will be used to name all the output files generated by Hifiasm.

Let’s wait a few minutes for the assembler to run. It will be fast, but while it runs, you can take some time to search what the parameters we used for running hifiasm mean. 
You can do that by either looking at the website or by opening a third tab/window and running hifiasm on help mode (e.g. `hifiasm -h`).

## Interpreting our results

Hifiasm outputs different intermediate files together with the final assembly result. 

Among the results hifiasm produces, you will find the `<prefix>.p_ctg.gfa` file (remember that the prefix has been defined using the `-o` option when running Hifiasm, the file name is likely to be mApoSyl1.60.hifiasm.p_ctg.gfa). 
This is our assembly output file. Hifiasm gives us the [assembly graph](http://gfa-spec.github.io/GFA-spec/GFA1.html) as an output. 
This means you need to convert the graph into a fasta file. For that, we have an awk script named `gfa2fa`.

Add the directory containing that script to the PATH and run it:

```console 
export PATH=path:$PATH
gfa2fa <prefix>.p_ctg.gfa > <prefix>.p_ctg.fa
```

Right. So now, what to do with the assembly file?
Well, first you should have a look at the statistics for this assembly. Let’s run our asmstats script on it:

```console  
asmstats <prefix>.p_ctg.fa > <prefix>.p_ctg.fa.stats
```

## WELL DONE!
You have just done eukaryotic genome assembly using PacBio HiFi with hifiasm! **That is fantastic!**

Again, let's remember you have ran hifiasm only for a subset of reads, which means this is never going to get you a complete assembly. So, for now, keep this results you have and lets look at statistics for an assembly I ran previously with the complete reads dataset.

## Part 2 

As I said, I ran hifiasm for a complete PacBio HiFi dataset for *Apodemus sylvaticus*. In my computer enviroment, it took around 170 hours and 76G memory. We don't have time to run it here, but you will work with the output of it now.
The files are on the working data folder (`mApoSyl1_data/`) and are named `mApoSyl1.hifiasm.total.[a/p]_ctg.fa.gz` (Hifiasm produces two different files, one with suffix `a_ctg.gfa.gz` and another one with the suffix `p_ctg.gfa.gz`, and I have converted them to fasta previously with gfa2fasta). Now, symlink these files to your working directory:

```bash
pwd
# where am I? Am I inside the hifiasm folder? If not, run this next command.
cd ~/a_sylvaticus/hifiasm/
#then symlink

ln -s path/assembly/mApoSyl1.hifiasm.total.p_ctg.fa.gz
ln -s path/assembly/mApoSyl1.hifiasm.total.a_ctg.fa.gz

# and run asmstats in both files
asmstats mApoSyl1.hifiasm.total.p_ctg.fa.gz > mApoSyl1.hifiasm.total.p_ctg.stats
asmstats mApoSyl1.hifiasm.total.a_ctg.fa.gz > mApoSyl1.hifiasm.total.a_ctg.stats

```

I have also generated BUSCO results for ```mApoSyl1.hifiasm.total.p_ctg.fa.gz``` . I want you to copy the files to your folder. 

```console
cp path/mApoSyl1.hifiasm.total.p_ctg.busco.short_summary.txt .

```

Another thing I want you to do is to look at the assembly graph. We discussed this during the lecture, the assembly graph is the organization level just before the flat linear contigs are outputed to the fasta sequence. Have a look at the assembly graph with Bandage (look at this tutorial here if you haven't yet downloaded [Bandage](https://rrwick.github.io/Bandage/). Download the file ```mApoSyl1.p_ctg.noseq.gfa.gz``` and open it on Bandage for a general view.

## VERY GOOD.

Now you have important outputs you should always look at as soon as an assembly run is done: you have the general statistics and you also have a BUSCO result (I have produced it previously) to understand the gene completness in the genome that was just assembled. With these results in hand, let's answer the following questions:

  1-) Hifiasm generates two files (p and a). Why? What do they mean? Have a look at the descriptions [here](https://hifiasm.readthedocs.io/en/latest/trio-assembly.html). 
  
  2-) What are the general statistics for your assembled genome ```mApoSyl1.hifiasm.total.p_ctg.stats```: assembly N50, assembled total bases, number of assembled contigs, largest, smallest...
  
  3-) What is the BUSCO result for the primary assembly?
  
  4-) How does the bandage graph look like? 

  # WELL DONE. You just completed the first step of genome assembly!

  Before we go back to the group, let's now have a look at the small dataset results you generated in Part 1.

  5-) What are the general statistics for the *p_ctg you generated? 
  
  6-) How many contigs were created in your hifiasm run with the small dataset?
  
  7-) During your run you hifiasm also generated a *p_ctg.noseq.gfa output. Can you download this an open it on Bandage. How does this assembly graph looks like? 
  
Now gather all these results and let’s go back to the larger group and discuss it all together!
